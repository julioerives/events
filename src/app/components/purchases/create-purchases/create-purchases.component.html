<div class="create-purchases-layout">
  <div class="summary-panel">
    <div class="summary-card">
      <div class="summary-header">
        <mat-icon>shopping_cart</mat-icon>
        <h3>Resumen de Compra</h3>
      </div>

      <div class="summary-content">
        <div class="summary-item">
          <span class="label">Productos agregados:</span>
          <span class="value">{{ totalItems() }}</span>
        </div>

        <div class="summary-item">
          <span class="label">Total a pagar:</span>
          <span class="value highlight">{{ totalAmount() | currency }}</span>
        </div>

        <div class="summary-item">
          <span class="label">Promedio por item:</span>
          <span class="value">{{ averagePerItem() | currency }}</span>
        </div>
      </div>

      <div class="summary-actions">
        <button type="button" class="btn btn-primary" (click)="onSubmit()"
          [disabled]="isLoading || purchaseForm.invalid">
          <span *ngIf="!isLoading">Confirmar Compra</span>
          <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
        </button>
      </div>
    </div>
  </div>

  <div class="form-panel">
    <div class="form-header">
      <h2>Detalles de la Compra</h2>
      <button matTooltip="Agregar otro producto" class="btn btn-secondary" (click)="addPurchase()">
        <mat-icon>add</mat-icon>
        <span>Agregar Producto</span>
      </button>
    </div>

    <form [formGroup]="purchaseForm">
      <div formArrayName="purchases" class="purchases-container">
        <div class="purchase-card" *ngFor="let purchase of purchasesArray.controls; let i = index">
          <div [formGroupName]="i" class="purchase-card-content">
            <div class="purchase-card-header">
              <h3>Producto #{{i + 1}}</h3>
              <button type="button" matTooltip="Eliminar producto" class="btn btn-icon danger" (click)="removePurchase(i)"
                *ngIf="purchasesArray.length > 1">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <div class="purchase-card-body">
              <div class="form-row">
                <div class="input-group">
                  <label>Tipo de Producto</label>
                  <div class="input-select">
                    <mat-select formControlName="incomeTypeId">
                      <mat-option value="" disabled selected>Seleccione tipo</mat-option>
                      <mat-option *ngFor="let type of incomeTypes" [value]="type.id">
                        {{type.name}}
                      </mat-option>
                    </mat-select>
                  </div>
                </div>

                <div class="input-group">
                  <label>Cantidad</label>
                  <input type="number" formControlName="quantity" class="input" step="0.01" min="0">
                </div>
              </div>

              <div class="form-row">
                <div class="input-group full-width">
                  <label>Fecha de Compra</label>
                  <div class="input-with-datepicker">
                    <input type="text" 
                           class="input"
                           formControlName="date"
                           [matDatepicker]="picker"
                           placeholder="Seleccione fecha">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </div>
                </div>
              </div>

              <div class="input-group full-width">
                <label>Descripci√≥n/Nombre del Producto</label>
                <textarea formControlName="description" class="input" rows="2"
                  placeholder="Ej. Laptop Dell XPS 15"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>